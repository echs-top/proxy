name: Update dnsmasq-china-list Rules

on:
  schedule:
    # 每天北京时间 3:20 (UTC 19:20)
    - cron: '20 19 * * *'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install Dependencies
        run: pip install requests

      - name: Download and Process Rules
        run: |
          python << 'EOF'
          import requests
          import re
          import os

          # 1. 完全对齐你参考代码中的清理和排序逻辑
          def clean_domain(d):
              return d.lstrip('+').lstrip('.')

          list_dir = 'rules/list'
          full_file = os.path.join(list_dir, 'dnsmasq-china_domain.list')
          cn_file = os.path.join(list_dir, 'cn_domain.list')
          add_file = os.path.join(list_dir, 'dnsmasq-china-add_domain.list')
          
          os.makedirs(list_dir, exist_ok=True)

          # 2. 获取原始数据
          source_url = "https://raw.githubusercontent.com/felixonmars/dnsmasq-china-list/refs/heads/master/accelerated-domains.china.conf"
          try:
              r = requests.get(source_url, timeout=20, headers={'User-Agent': 'Mozilla/5.0'})
              r.raise_for_status()
              # 提取 dnsmasq 格式中的域名
              domains = re.findall(r'^server=/([^/]+)/', r.text, re.MULTILINE)
              # 统一转为 Mihomo 识别的 +. 格式
              raw_items = [f"+.{d}" for d in domains]
          except Exception as e:
              print(f"LOG: Fetch Error: {e}")
              exit(1)

          # 3. 内部去重合并（确保 dnsmasq 列表本身也是精简的）
          # 使用你要求的倒序排序技巧
          sorted_items = sorted(raw_items, key=lambda x: clean_domain(x).split('.')[::-1])
          
          dnsmasq_final_full = []
          last_kept = None
          for item in sorted_items:
              curr = clean_domain(item)
              if last_kept and (curr == last_kept or curr.endswith('.' + last_kept)):
                  continue
              dnsmasq_final_full.append(item)
              last_kept = curr

          # 写入全量文件
          with open(full_file, 'w', encoding='utf-8') as f:
              for line in sorted(dnsmasq_final_full):
                  f.write(f"{line}\n")

          # 4. 关键：排除 cn_domain.list 中已有的条目
          # 遵循“全局加载”原则，一次性加载 cn_domain.list
          if os.path.exists(cn_file):
              with open(cn_file, 'r', encoding='utf-8') as f:
                  cn_cleans = [clean_domain(l.strip()) for l in f if l.strip() and not l.startswith(('#', '//'))]
              
              final_add_only = []
              for item in dnsmasq_final_full:
                  curr = clean_domain(item)
                  # 如果 cn_domain.list 里已经有这个域或它的父域，就跳过
                  if any(curr == cn or curr.endswith('.' + cn) for cn in cn_cleans):
                      continue
                  final_add_only.append(item)
              
              with open(add_file, 'w', encoding='utf-8') as f:
                  for line in sorted(final_add_only):
                      f.write(f"{line}\n")
              print(f"LOG: Created {add_file} with {len(final_add_only)} items.")
          else:
              # 如果 cn_domain.list 不存在，add_domain 就等于全量
              with open(add_file, 'w', encoding='utf-8') as f:
                  for line in sorted(dnsmasq_final_full):
                      f.write(f"{line}\n")
              print(f"LOG: cn_domain.list not found, copied full to add.")
          EOF

      - name: Commit and Push
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add rules/list/dnsmasq-china_domain.list
          git add rules/list/dnsmasq-china-add_domain.list
          
          if git diff --staged --quiet; then
            echo "No changes detected."
          else
            git commit -m "Update dnsmasq lists (full & add) $(date +'%Y-%m-%d %H:%M')"
            git push
          fi
