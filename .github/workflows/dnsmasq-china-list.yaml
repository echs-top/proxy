name: Update dnsmasq-china-list Rules

on:
  schedule:
    # 每天北京时间 3:20 (UTC 19:20)
    - cron: '20 19 * * *'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Cache Pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-requests
          restore-keys: ${{ runner.os }}-pip-

      - name: Install Dependencies
        run: pip install requests

      - name: Download and Process Rules
        run: |
          python << 'EOF'
          import requests
          import re
          import os

          def clean_domain(d):
              # 兼容处理：去除 Mihomo 可能存在的 +. 前缀或首尾空格
              return d.strip().lstrip('+').lstrip('.')

          list_dir = 'rules/list'
          full_file = os.path.join(list_dir, 'dnsmasq-china_domain.list')
          cn_file = os.path.join(list_dir, 'cn_domain.list')
          add_file = os.path.join(list_dir, 'dnsmasq-china-add_domain.list')
          
          os.makedirs(list_dir, exist_ok=True)

          # 1. 下载 dnsmasq-china-list (FelixOnMars 源)
          source_url = "https://raw.githubusercontent.com/felixonmars/dnsmasq-china-list/refs/heads/master/accelerated-domains.china.conf"
          try:
              r = requests.get(source_url, timeout=20, headers={'User-Agent': 'Mozilla/5.0'})
              r.raise_for_status()
              # 正则提取 server=/domain.com/114.114.114.114 中的 domain.com
              domains = re.findall(r'^server=/([^/]+)/', r.text, re.MULTILINE)
              # 转换为标准 Mihomo list 格式: +.domain.com
              raw_items = [f"+.{d}" for d in domains]
          except Exception as e:
              print(f"LOG: Error fetching source: {e}")
              exit(1)

          # --- 步骤 1: 内部去重与合并 (生成全量列表) ---
          # 按域名后缀倒序排序，确保父域名排在子域名前面
          sorted_items = sorted(raw_items, key=lambda x: clean_domain(x).split('.')[::-1])
          final_full_list = []
          last_kept_clean = None
          
          for item in sorted_items:
              current_clean = clean_domain(item)
              # 如果当前域名是上一个已保留域名的子项，则跳过
              if last_kept_clean and (current_clean == last_kept_clean or current_clean.endswith('.' + last_kept_clean)):
                  continue
              else:
                  final_full_list.append(item)
                  last_kept_clean = current_clean

          # 保存全量文件
          with open(full_file, 'w', encoding='utf-8') as f:
              for line in sorted(final_full_list):
                  f.write(f"{line}\n")
          print(f"LOG: Saved full list to {full_file}")

          # --- 步骤 2: 排除 cn_domain.list 已有的规则 ---
          if os.path.exists(cn_file):
              with open(cn_file, 'r', encoding='utf-8') as f:
                  # 读取并清理对比文件的每一行
                  cn_rules = [clean_domain(l) for l in f if l.strip() and not l.strip().startswith(('#', '//'))]
              
              final_add_list = []
              for item in final_full_list:
                  current_clean = clean_domain(item)
                  
                  # 核心逻辑：如果在 cn_domain.list 中找到了当前域名或其父域名，则排除
                  # 例如：cn_rules 里有 'baidu.com'，那么 '+.baidu.com' 或 '+.www.baidu.com' 都会被排除
                  is_redundant = False
                  for cn in cn_rules:
                      if current_clean == cn or current_clean.endswith('.' + cn):
                          is_redundant = True
                          break
                  
                  if not is_redundant:
                      final_add_list.append(item)
              
              with open(add_file, 'w', encoding='utf-8') as f:
                  for line in sorted(final_add_list):
                      f.write(f"{line}\n")
              print(f"LOG: Saved additional list to {add_file}, filtered {len(final_full_list) - len(final_add_list)} redundant items.")
          else:
              print(f"LOG: {cn_file} not found, add_domain.list will be identical to full list.")
              with open(add_file, 'w', encoding='utf-8') as f:
                  for line in sorted(final_full_list):
                      f.write(f"{line}\n")
          EOF

      - name: Commit and Push
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # 确保将整个 rules/list 目录下的改动加入暂存区
          git add rules/list/dnsmasq-china_domain.list
          git add rules/list/dnsmasq-china-add_domain.list
          
          if git diff --staged --quiet; then
            echo "No changes detected."
          else
            git commit -m "Update dnsmasq-china rules (full & additional) $(date +'%Y-%m-%d %H:%M')"
            git push
          fi
