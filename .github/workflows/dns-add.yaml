name: Update DNS Add Admin Rules

on:
  schedule:
    # 每天北京时间 3:20 (UTC 19:20)
    - cron: '20 19 * * *'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Cache Pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-requests
          restore-keys: ${{ runner.os }}-pip-

      - name: Install Dependencies
        run: pip install requests

      - name: Download and Process Rules
        run: |
          python << 'EOF'
          import requests
          import re
          import os

          def clean_domain(d):
              """移除前缀 + 和 . 以获取纯域名"""
              return d.lstrip('+').lstrip('.')

          def get_remote_data(url):
              """下载 dnsmasq 格式并转换为 +.domain 格式"""
              print(f"LOG: Fetching {url}")
              try:
                  r = requests.get(url, timeout=20, headers={'User-Agent': 'Mozilla/5.0'})
                  r.raise_for_status()
                  # 正则匹配 server=/domain.com/114... 并提取 domain.com
                  # 转换为 +.domain.com
                  domains = re.findall(r'^server=/([^/]+)/', r.text, re.MULTILINE)
                  return [f"+.{d}" for d in domains]
              except Exception as e:
                  print(f"LOG: Error fetching {url}: {e}")
                  return []

          def load_local_list(path):
              """加载本地已有的规则列表列表"""
              if not os.path.exists(path):
                  print(f"LOG: Local file {path} not found.")
                  return set()
              with open(path, 'r', encoding='utf-8') as f:
                  # 存储为 clean 后的域名集合用于快速对比
                  return {clean_domain(line.strip()) for line in f if line.strip()}

          # 1. 下载并预处理 dnsmasq 数据
          source_url = "https://raw.githubusercontent.com/felixonmars/dnsmasq-china-list/refs/heads/master/accelerated-domains.china.conf"
          raw_items = get_remote_data(source_url)
          
          if not raw_items:
              print("LOG: No data downloaded. Exiting.")
              exit(0)

          # 2. 加载 cn_domain.list 进行过滤去重
          # 假设 cn_domain.list 路径在 rules/list/cn_domain.list
          local_cn_path = 'rules/list/cn_domain.list'
          existing_cn_domains = load_local_list(local_cn_path)
          
          # 过滤掉已经存在于 cn_domain.list 中的域名
          filtered_items = [item for item in raw_items if clean_domain(item) not in existing_cn_domains]
          print(f"LOG: After CN filtering, {len(filtered_items)} items remain.")

          # 3. 内部高效率去重（父子域合并）
          # 按域名倒序排序：com.baidu.www
          sorted_items = sorted(filtered_items, key=lambda x: clean_domain(x).split('.')[::-1])

          final_list = []
          last_kept_clean = None
          
          for item in sorted_items:
              current_clean = clean_domain(item)
              # 如果当前域名是上一个保留域名的子项，或者是完全重复，则跳过
              if last_kept_clean and (current_clean == last_kept_clean or current_clean.endswith('.' + last_kept_clean)):
                  continue
              else:
                  final_list.append(item)
                  last_kept_clean = current_clean

          print(f"LOG: Final items after hierarchical deduplication: {len(final_list)}")

          # 4. 写入文件
          out_file = 'rules/list/dns-add_admin.list'
          os.makedirs(os.path.dirname(out_file), exist_ok=True)
          with open(out_file, 'w', encoding='utf-8') as f:
              for line in sorted(final_list):
                  f.write(f"{line}\n")
          print(f"LOG: Saved to {out_file}")
          EOF

      - name: Commit and Push
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add rules/list/dns-add_admin.list
          if git diff --staged --quiet; then
            echo "No changes detected."
          else
            git commit -m "Update DNS Add Admin rules $(date +'%Y-%m-%d %H:%M')"
            git push
          fi
