name: Update Enhanced FaaS IPs

on:
  schedule:
    - cron: '0 19 * * *' # 北京时间凌晨 3 点
  workflow_dispatch:

jobs:
  update-list:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Fetch and Process
        id: process
        run: |
          mkdir -p rules/list/
          output_file="rules/list/enhanced-FaaS-in-China_ip.list"
          temp_raw="all_data.json"
          
          # 1. 全局加载资源：下载所有 JSON
          urls=(
            "https://raw.githubusercontent.com/xingpingcn/enhanced-FaaS-in-China/main/Cf.json"
            "https://raw.githubusercontent.com/xingpingcn/enhanced-FaaS-in-China/main/Netlify.json"
            "https://raw.githubusercontent.com/xingpingcn/enhanced-FaaS-in-China/main/Vercel.json"
          )
          for url in "${urls[@]}"; do
            curl -sL "$url" >> "$temp_raw"
          done

          # 2. 深度解析并提取：
          # .. | objects 寻找所有对象
          # select(has("dianxin")) 锁定包含运营商数据的层级
          # 提取数组内容，去重，添加 /32 结尾
          if [ -f "$output_file" ]; then cp "$output_file" old_list.tmp; fi

          cat "$temp_raw" | jq -r '.. | objects | select(has("dianxin")) | .dianxin[], .yidong[], .liantong[]' | \
          grep -E -o "([0-9]{1,3}\.){3}[0-9]{1,3}" | \
          sort -u | \
          sed 's/$/\/32/' > "$output_file"

          # 3. 变化检测（缓存优化逻辑）
          if diff -q "$output_file" old_list.tmp >/dev/null 2>&1; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit and Push
        if: steps.process.outputs.changed == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add rules/list/enhanced-FaaS-in-China_ip.list
          git commit -m "Auto-update IPs: $(date +'%Y-%m-%d %H:%M')"
          git push
