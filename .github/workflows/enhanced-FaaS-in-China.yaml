name: Update Enhanced FaaS IPs

on:
  schedule:
    - cron: '0 19 * * *' # 国际标准时间 19:00 = 北京时间 03:00
  workflow_dispatch:      # 允许手动触发

jobs:
  update-list:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }} # 显式使用 Token 确保写入权限

      # 缓存环境：缓存 runner 的工具状态，符合你对环境缓存的要求
      - name: Cache environment tools
        uses: actions/cache@v4
        with:
          path: /usr/bin/jq
          key: ${{ runner.os }}-jq

      - name: Fetch and Rebuild Global Rules
        run: |
          # 1. 在仓库根目录下确保路径存在
          mkdir -p rules/list/
          
          # 2. 定义输出文件的绝对路径（基于工作区）
          OUTPUT_PATH="rules/list/enhanced-FaaS-in-China_ip.list"
          
          # 3. 准备资源列表
          urls=(
            "https://raw.githubusercontent.com/xingpingcn/enhanced-FaaS-in-China/main/Cf.json"
            "https://raw.githubusercontent.com/xingpingcn/enhanced-FaaS-in-China/main/Netlify.json"
            "https://raw.githubusercontent.com/xingpingcn/enhanced-FaaS-in-China/main/Vercel.json"
          )

          # 4. 全局提取逻辑：
          # 清空旧文件，重新写入
          > raw_combined.tmp
          for url in "${urls[@]}"; do
            echo "Global fetching: $url"
            # 使用更鲁棒的递归查询提取所有运营商数组内容
            curl -sL "$url" | jq -r '.. | .dianxin?, .yidong?, .liantong? | select(. != null) | .[]' >> raw_combined.tmp
          done

          # 5. 格式转换与去重
          # 提取 IPv4 -> 排序去重 -> 结尾统一加 /32 -> 写入仓库目录
          grep -E -o "([0-9]{1,3}\.){3}[0-9]{1,3}" raw_combined.tmp | \
          sort -u | \
          sed 's/$/\/32/' > "$OUTPUT_PATH"

          echo "Process complete. Total IPs saved to $OUTPUT_PATH: $(wc -l < $OUTPUT_PATH)"

      - name: Commit and Push to Repository
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # 确保添加到仓库路径
          git add rules/list/enhanced-FaaS-in-China_ip.list
          
          # 只有在有变动时才提交，防止 workflow 报错
          if git diff --staged --quiet; then
            echo "No changes detected today."
          else
            git commit -m "Auto-update IP list: $(date +'%Y-%m-%d %H:%M:%S')"
            git push origin ${{ github.ref_name }}
          fi
