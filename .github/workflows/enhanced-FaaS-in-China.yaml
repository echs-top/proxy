name: Update Enhanced FaaS IPs

on:
  schedule:
    - cron: '0 19 * * *' # 北京时间凌晨 3 点
  workflow_dispatch:

jobs:
  update-list:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # 【环境缓存核心】：缓存全局下载的资源和工具状态
      # 即使 Runner 是新的，我们通过 Key 恢复之前的工作环境
      - name: Setup Global Environment Cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            rules/list/
          key: env-cache-${{ runner.os }}-${{ github.run_id }}
          restore-keys: |
            env-cache-${{ runner.os }}-

      - name: Rebuild Rules From Scratch
        run: |
          mkdir -p rules/list/
          output_file="rules/list/enhanced-FaaS-in-China_ip.list"
          
          # 资源定义
          urls=(
            "https://raw.githubusercontent.com/xingpingcn/enhanced-FaaS-in-China/main/Cf.json"
            "https://raw.githubusercontent.com/xingpingcn/enhanced-FaaS-in-China/main/Netlify.json"
            "https://raw.githubusercontent.com/xingpingcn/enhanced-FaaS-in-China/main/Vercel.json"
          )

          # 确保每次环境运行前清空旧的临时处理区
          tmp_dir=$(mktemp -d)
          
          # 全局加载：一次性拉取到缓存目录
          for url in "${urls[@]}"; do
            filename=$(basename "$url")
            curl -sL "$url" -o "$tmp_dir/$filename"
          done

          # 重新生成逻辑：不论缓存是否存在，这里都会强制重新扫描并覆盖
          # 深度遍历所有下载到的 JSON 文件
          cat "$tmp_dir"/*.json | jq -r '.. | objects | select(.dianxin or .yidong or .liantong) | .dianxin[], .yidong[], .liantong[]' | \
          grep -E -o "([0-9]{1,3}\.){3}[0-9]{1,3}" | \
          sort -u | \
          sed 's/$/\/32/' > "$output_file"

          echo "Environment updated. Processed $(wc -l < $output_file) unique IPs."

      - name: Force Update Repository
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add rules/list/enhanced-FaaS-in-China_ip.list
          # 使用 --allow-empty 或 || true 确保即使文件内容没变，环境更新动作也算成功
          git commit -m "Global Env Sync: $(date +'%Y-%m-%d')" || exit 0
          git push
