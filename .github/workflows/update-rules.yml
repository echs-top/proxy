# --- 2. å¤„ç†æœ¬åœ° rules è§„åˆ™æ–‡ä»¶ (åŸºäºæœ€åæäº¤æ—¶é—´) ---
      - name: ğŸ› ï¸ Convert Local Rules to MRS (Use Last Commit Time)
        run: |
          echo "Starting local rules conversion..."
          TEMP_DIR=$(mktemp -d)
          
          # æ£€æŸ¥ rules ç›®å½•æ˜¯å¦å­˜åœ¨
          if [ ! -d "rules" ]; then
              echo "Rules directory not found. Skipping local rules conversion."
              exit 0
          fi
          
          find rules -type f -name "*.list" | while read -r file; do
            filename=$(basename "$file" .list)
            mrs_file="mrs/${filename}.mrs"
            temp_list="${TEMP_DIR}/${filename}.list.tmp"
            
            # 1. è·å–è¾“å…¥è§„åˆ™æ–‡ä»¶çš„æœ€åæäº¤æ—¶é—´
            # %at: Author date, Unix timestamp
            # --: ç¡®ä¿æ–‡ä»¶è·¯å¾„ä¸å—åˆ†æ”¯/æ ‡ç­¾å½±å“
            INPUT_COMMIT_TIME=$(git log -1 --format=%at -- "$file" 2>/dev/null || echo 0)
            
            # 2. è·å–è¾“å‡º MRS æ–‡ä»¶çš„æœ€åæäº¤æ—¶é—´ (å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ™æ—¶é—´ä¸º 0)
            if [ -f "$mrs_file" ]; then
                # å¦‚æœæ–‡ä»¶åœ¨ HEAD ä¸­å­˜åœ¨ï¼Œæˆ‘ä»¬ç”¨ HEAD çš„æäº¤æ—¶é—´
                MRS_COMMIT_TIME=$(git log -1 --format=%at -- "$mrs_file" 2>/dev/null || echo 0)
            else
                MRS_COMMIT_TIME=0
            fi

            echo "  -> ${file} Commit Time: ${INPUT_COMMIT_TIME}"
            echo "  -> ${mrs_file} Commit Time: ${MRS_COMMIT_TIME}"
            
            # 3. åˆ¤æ–­æ˜¯å¦éœ€è¦è½¬æ¢
            # è½¬æ¢æ¡ä»¶ï¼š
            # A) MRS æ–‡ä»¶ä¸å­˜åœ¨ (MRS_COMMIT_TIME == 0)
            # B) è¾“å…¥è§„åˆ™æ–‡ä»¶çš„æäº¤æ—¶é—´ æ™šäº è¾“å‡º MRS æ–‡ä»¶çš„æäº¤æ—¶é—´ (INPUT_COMMIT_TIME > MRS_COMMIT_TIME)
            if [ "$INPUT_COMMIT_TIME" -gt "$MRS_COMMIT_TIME" ] || [ "$MRS_COMMIT_TIME" -eq 0 ]; then
                SHOULD_CONVERT="true"
                echo "  - **Action:** Converting (Input is newer or MRS missing)."
            else
                SHOULD_CONVERT="false"
                echo "  - Skipping (MRS is up-to-date): ${file}"
            fi
            
            # å¦‚æœä¸åº”è¯¥è½¬æ¢ï¼Œåˆ™è·³è¿‡åç»­æ­¥éª¤
            if [ "$SHOULD_CONVERT" == "false" ]; then
                continue
            fi
            
            # --- 4. è½¬æ¢æµç¨‹ ---
            
            # åˆ¤æ–­æ–‡ä»¶ç±»å‹å¹¶è®¾ç½® behavior
            if [[ "$file" == *"_domain.list" ]]; then
              BEHAVIOR="domain"
            elif [[ "$file" == *"_ip.list" ]]; then
              BEHAVIOR="ipcidr"
            else
              echo "  - Skipping file (unknown type, must contain _domain.list or _ip.list): ${file}"
              continue
            fi
            
            # é¢„æ¸…ç†ï¼šå»é™¤æ³¨é‡Šå’Œç©ºè¡Œï¼Œå¹¶å†™å…¥ä¸´æ—¶æ–‡ä»¶
            grep -v '^[[:space:]]*[#;]' "$file" | \
            grep -v '^[[:space:]]*$' | \
            sed 's/[[:space:]]*[#;].*//' > "$temp_list"
            
            # æ£€æŸ¥ä¸´æ—¶æ–‡ä»¶æ˜¯å¦ä¸ºç©º (é¿å… panic: empty rule)
            if [ ! -s "$temp_list" ]; then
              echo "  - **Skipping file (Empty/Only Comments):** ${file}"
              [ -f "$mrs_file" ] && rm "$mrs_file"
              rm "$temp_list" 
              continue
            fi
            
            echo "  - Executing conversion to ${mrs_file}"

            # è½¬æ¢ï¼šä½¿ç”¨ä¸´æ—¶æ–‡ä»¶ä½œä¸ºè¾“å…¥
            /usr/local/bin/mihomo convert-ruleset ${BEHAVIOR} text "$temp_list" "$mrs_file"
            echo "Converted successfully."
            
            # æ¸…ç†æœ¬æ¬¡å¾ªç¯çš„ä¸´æ—¶æ–‡ä»¶
            rm "$temp_list"
          done
          echo "Local rules conversion complete."
          
          rm -rf "$TEMP_DIR"
