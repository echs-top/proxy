name: Mihomo Rules Update

# æ¯å¤© UTC æ—¶é—´ 20:00 è¿è¡Œ (ç›¸å½“äºåŒ—äº¬æ—¶é—´æ¬¡æ—¥ 04:00)
on:
  workflow_dispatch:
  schedule:
    - cron: '0 20 * * *' 

env:
  MIHOMO_OWNER: MetaCubeX
  MIHOMO_REPO: mihomo

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: â¬‡ï¸ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 

      # --- 1. è‡ªåŠ¨è·å–æœ€æ–°ç‰ˆæœ¬å¹¶æ£€æµ‹æ›´æ–° ---
      - name: ğŸ” Get Latest Mihomo Release Tag
        id: get-version
        run: |
          # è·å–æœ€æ–° Release Tag (ä¾‹å¦‚ v1.19.15)
          LATEST_TAG=$(curl -s "https://api.github.com/repos/${{ env.MIHOMO_OWNER }}/${{ env.MIHOMO_REPO }}/releases/latest" | jq -r .tag_name)
          
          if [ -z "$LATEST_TAG" ] || [ "$LATEST_TAG" == "null" ]; then
            echo "::error::Failed to retrieve latest Mihomo tag from GitHub API."
            exit 1
          fi

          echo "Latest Mihomo Tag: $LATEST_TAG"
          echo "LATEST_TAG=$LATEST_TAG" >> $GITHUB_ENV
        
      - name: âš™ï¸ Setup Mihomo Cache (Check for Update)
        id: cache-mihomo
        uses: actions/cache@v4
        with:
          path: /usr/local/bin/mihomo
          # ä½¿ç”¨æœ€æ–°çš„ Tag ä½œä¸º Key çš„ä¸€éƒ¨åˆ†
          key: ${{ runner.os }}-mihomo-${{ env.LATEST_TAG }} 
          
      - name: ğŸ“¥ Download, Unzip, and Install Mihomo
        if: steps.cache-mihomo.outputs.cache-hit != 'true'
        run: |
          MIHOMO_VERSION="${{ env.LATEST_TAG }}"
          
          # æ ¹æ®ç‰ˆæœ¬å·å’Œæ–‡ä»¶åæ¨¡å¼æ„é€  URL
          FILE_NAME="mihomo-linux-amd64-${MIHOMO_VERSION}.gz" 
          MIHOMO_URL="https://github.com/${{ env.MIHOMO_OWNER }}/${{ env.MIHOMO_REPO }}/releases/download/${MIHOMO_VERSION}/${FILE_NAME}"
          TEMP_FILE="mihomo_temp.gz"
          EXEC_FILE="mihomo_temp"
          
          echo "Cache Miss or Version Updated. Downloading Mihomo from: ${MIHOMO_URL}"
          
          # 1. ä¸‹è½½ .gz æ–‡ä»¶
          if ! curl -fsSL -o "${TEMP_FILE}" "${MIHOMO_URL}"; then
              echo "::error::Failed to download Mihomo. Please verify the file name pattern."
              exit 1
          fi
          
          # 2. è§£å‹ç¼© .gz æ–‡ä»¶
          echo "Unzipping Mihomo..."
          if ! gunzip "${TEMP_FILE}"; then
              echo "::error::Failed to unzip Mihomo. The downloaded file may be corrupted."
              exit 1
          fi

          # 3. éªŒè¯è§£å‹åçš„æ–‡ä»¶
          if ! file "${EXEC_FILE}" | grep -q 'ELF 64-bit LSB executable'; then
            echo "::error::Mihomo file is not a valid Linux binary after decompression."
            exit 1 
          fi
          
          # 4. èµ‹äºˆæ‰§è¡Œæƒé™å¹¶å®‰è£…åˆ°ç³»ç»Ÿè·¯å¾„
          chmod +x "${EXEC_FILE}"
          sudo mv "${EXEC_FILE}" /usr/local/bin/mihomo
          echo "Mihomo installed successfully: ${MIHOMO_VERSION}"
          
      - name: ğŸ” Verify Mihomo Installation
        run: mihomo -v

      # --- 2. å‡†å¤‡å·¥ä½œç›®å½• ---
      - name: ğŸ“‚ Create Output Directory
        run: mkdir -p mrs

      # --- 3. å¤„ç†æœ¬åœ° rules è§„åˆ™æ–‡ä»¶ (ä½¿ç”¨ rule convert) ---
      - name: â³ Check Local Rules Update Time
        id: check-local-rules
        run: |
          LAST_COMMIT_TIME=$(git log -1 --pretty=format:%at -- rules || echo 0)
          
          echo "Last Rules Commit Time (Unix): $LAST_COMMIT_TIME"
          
          if [ "$LAST_COMMIT_TIME" -gt 0 ]; then
            echo "Rules folder has updates. Will regenerate."
            echo "SHOULD_REGENERATE=true" >> $GITHUB_ENV
          else
            echo "Rules folder has no updates or is empty. Skipping regeneration."
            echo "SHOULD_REGENERATE=false" >> $GITHUB_ENV
          fi
          
      - name: ğŸ› ï¸ Convert Local Rules to MRS
        if: env.SHOULD_REGENERATE == 'true'
        run: |
          echo "Converting local rules using 'mihomo rule convert'..."
          # å¤„ç† _domain.list å’Œ _ip.list ç­‰æ™®é€š Rule File
          find rules -type f -name "*.list" | while read -r file; do
            filename=$(basename "$file" .list)
            # ä½¿ç”¨ rule convert å³å¯ï¼Œæ— éœ€é¢å¤–å‚æ•°
            /usr/local/bin/mihomo rule convert -F "$file" -O "mrs/${filename}.mrs"
            echo "Converted ${file} to mrs/${filename}.mrs"
          done
          echo "Local rules conversion complete."
          
      # --- 4. å¤„ç†è¿œç¨‹ YAML è§„åˆ™é›† (ä½¿ç”¨ convert-ruleset) ---
      - name: ğŸŒ Download Remote YAML RuleSet
        run: |
          REMOTE_URL="https://raw.githubusercontent.com/TG-Twilight/AWAvenue-Ads-Rule/main/Filters/AWAvenue-Ads-Rule-Clash.yaml"
          echo "Downloading remote RuleSet: ${REMOTE_URL}"
          curl -L -o remote-rule.yaml "$REMOTE_URL"
          echo "Remote YAML RuleSet downloaded."
          
      - name: ğŸ”„ Convert Remote RuleSet to MRS
        run: |
          echo "Converting remote RuleSet using 'mihomo convert-ruleset'..."
          # ä½¿ç”¨ convert-ruleset domain yaml è½¬æ¢è¿œç¨‹çš„ RuleSet æ–‡ä»¶
          /usr/local/bin/mihomo convert-ruleset domain yaml remote-rule.yaml mrs/AWAvenue-Ads-Rule.mrs
          echo "Remote RuleSet conversion complete."

      # --- 5. æäº¤æ›´æ”¹å›ä»“åº“ ---
      - name: â¬†ï¸ Commit and Push Changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ğŸ¤– Feat: Update Mihomo MRS Rules"
          branch: ${{ github.ref_name }}
          file_pattern: 'mrs/*'
          commit_options: '--allow-empty --no-edit'
