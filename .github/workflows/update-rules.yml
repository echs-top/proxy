name: Mihomo Rules Update

# æ¯å¤© UTC æ—¶é—´ 20:00 è¿è¡Œ (ç›¸å½“äºåŒ—äº¬æ—¶é—´æ¬¡æ—¥ 04:00)
on:
  workflow_dispatch:
  schedule:
    - cron: '0 20 * * *' 

env:
  MIHOMO_OWNER: MetaCubeX
  MIHOMO_REPO: mihomo
  REMOTE_RULES_URL: https://raw.githubusercontent.com/TG-Twilight/AWAvenue-Ads-Rule/main/Filters/AWAvenue-Ads-Rule-Clash.yaml
  REMOTE_RULES_MRS_FILE: mrs/AWAvenue-Ads-Rule.mrs
  
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: â¬‡ï¸ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 

      # --- 1. å®‰è£… Mihomo (ä¿æŒä¸å˜) ---
      - name: ğŸ” Get Latest Mihomo Release Tag
        id: get-version
        run: |
          LATEST_TAG=$(curl -s "https://api.github.com/repos/${{ env.MIHOMO_OWNER }}/${{ env.MIHOMO_REPO }}/releases/latest" | jq -r .tag_name)
          if [ -z "$LATEST_TAG" ] || [ "$LATEST_TAG" == "null" ]; then
            echo "::error::Failed to retrieve latest Mihomo tag from GitHub API."
            exit 1
          fi
          echo "LATEST_TAG=$LATEST_TAG" >> $GITHUB_ENV
        
      - name: âš™ï¸ Setup Mihomo Cache
        id: cache-mihomo
        uses: actions/cache@v4
        with:
          path: /usr/local/bin/mihomo
          key: ${{ runner.os }}-mihomo-${{ env.LATEST_TAG }} 
          
      - name: ğŸ“¥ Download, Unzip, and Install Mihomo
        if: steps.cache-mihomo.outputs.cache-hit != 'true'
        run: |
          MIHOMO_VERSION="${{ env.LATEST_TAG }}"
          FILE_NAME="mihomo-linux-amd64-${MIHOMO_VERSION}.gz" 
          MIHOMO_URL="https://github.com/${{ env.MIHOMO_OWNER }}/${{ env.MIHOMO_REPO }}/releases/download/${MIHOMO_VERSION}/${FILE_NAME}"
          TEMP_FILE="mihomo_temp.gz"
          EXEC_FILE="mihomo_temp"
          curl -fsSL -o "${TEMP_FILE}" "${MIHOMO_URL}" || exit 1
          gunzip "${TEMP_FILE}" || exit 1
          chmod +x "${EXEC_FILE}"
          sudo mv "${EXEC_FILE}" /usr/local/bin/mihomo
          echo "Mihomo installed successfully: ${MIHOMO_VERSION}"
          
      - name: ğŸ” Verify Mihomo Installation
        run: mihomo -v

      - name: ğŸ“‚ Create Output Directory
        run: mkdir -p mrs

      # --- 2. å¤„ç†æœ¬åœ° rules è§„åˆ™æ–‡ä»¶ (å¢åŠ  Git HASH æ¯”å¯¹ï¼Œè·³è¿‡æœªä¿®æ”¹çš„æ–‡ä»¶) ---
      - name: ğŸ› ï¸ Convert Local Rules to MRS (Skip Unchanged Files)
        run: |
          echo "Starting local rules conversion..."
          # è·å– rules ç›®å½•ä¸‹æ‰€æœ‰ .list æ–‡ä»¶çš„ HASH å¹¶å¯¹æ¯”
          find rules -type f -name "*.list" | while read -r file; do
            filename=$(basename "$file" .list)
            mrs_file="mrs/${filename}.mrs"
            
            # 1. æ£€æŸ¥æœ¬åœ°æ–‡ä»¶æ˜¯å¦æœ‰æ›´æ”¹ (ä½¿ç”¨ Git hash)
            CURRENT_HASH=$(git hash-object "$file")
            LAST_HASH=$(git cat-file -p "HEAD:$file" 2>/dev/null | git hash-object --stdin 2>/dev/null || echo "")

            if [ "$CURRENT_HASH" == "$LAST_HASH" ] && [ -f "$mrs_file" ]; then
              echo "  - Skipping (No change to rules file): ${file}"
              continue
            fi
            
            # 2. åˆ¤æ–­æ–‡ä»¶ç±»å‹å¹¶è®¾ç½® behavior
            if [[ "$file" == *"_domain.list" ]]; then
              BEHAVIOR="domain"
            elif [[ "$file" == *"_ip.list" ]]; then
              BEHAVIOR="ipcidr"
            else
              echo "  - Skipping file (unknown type): ${file}"
              continue
            fi
            
            # 3. é¢„æ¸…ç†å†…å®¹
            CLEANED_CONTENT=$(
              grep -v '^[[:space:]]*[#;]' "$file" | # ç§»é™¤ä»¥ # æˆ– ; å¼€å¤´çš„è¡Œ
              grep -v '^[[:space:]]*$' |           # ç§»é™¤ç©ºè¡Œ
              sed 's/[[:space:]]*[#;].*//'         # ç§»é™¤è¡Œå°¾çš„æ³¨é‡Š
            )
            
            # 4. æ£€æŸ¥æ¸…ç†åçš„å†…å®¹æ˜¯å¦ä¸ºç©º (é¿å… panic: empty rule)
            if [ -z "$CLEANED_CONTENT" ]; then
              echo "  - **Skipping file (Empty/Only Comments):** ${file}"
              # ç¡®ä¿åˆ é™¤ç©ºçš„ mrs æ–‡ä»¶ï¼Œä»¥é˜²è¢«æäº¤
              [ -f "$mrs_file" ] && rm "$mrs_file"
              continue
            fi
            
            echo "  - Converting ${file} to ${mrs_file}"

            # 5. è½¬æ¢
            echo "$CLEANED_CONTENT" | /usr/local/bin/mihomo convert-ruleset ${BEHAVIOR} text - "$mrs_file"
            echo "Converted successfully."
          done
          echo "Local rules conversion complete."
          
      # --- 3. å¤„ç†è¿œç¨‹ YAML è§„åˆ™é›† (å¼•å…¥ç‰ˆæœ¬æ£€æµ‹) ---
      - name: ğŸ’¾ Get Remote Rules Previous Version
        id: cache-remote-version
        uses: actions/cache@v4
        with:
          # ç¼“å­˜ key ä¾èµ–äºå›ºå®šçš„æ–‡ä»¶å
          path: remote-version.txt
          key: remote-rules-version-${{ hashFiles('remote-version.txt') }}
          restore-keys: |
            remote-rules-version-

      - name: ğŸŒ Download and Check Remote RuleSet Version
        id: remote-check
        run: |
          # 1. ä¸‹è½½è¿œç¨‹è§„åˆ™
          echo "Downloading remote RuleSet from: ${{ env.REMOTE_RULES_URL }}"
          curl -L -o remote-rule.yaml "${{ env.REMOTE_RULES_URL }}"
          
          # 2. æå–å½“å‰ä¸‹è½½è§„åˆ™çš„ç‰ˆæœ¬å·
          # æŸ¥æ‰¾ #Version: å¼€å¤´çš„è¡Œï¼Œæå–åé¢çš„ç‰ˆæœ¬å·
          CURRENT_VERSION=$(grep '^[[:space:]]*#Version:' remote-rule.yaml | head -n 1 | sed 's/^[[:space:]]*#Version:[[:space:]]*//')
          
          if [ -z "$CURRENT_VERSION" ]; then
            echo "::warning::Could not find Version tag in remote YAML file. Forcing conversion."
            CURRENT_VERSION="FORCE_CONVERT_$(date +%s)"
          fi

          echo "Current Remote Version: $CURRENT_VERSION"
          echo "CURRENT_VERSION=$CURRENT_VERSION" >> $GITHUB_ENV
          
          # 3. è¯»å–ç¼“å­˜çš„æ—§ç‰ˆæœ¬å·
          if [ -f "remote-version.txt" ]; then
            OLD_VERSION=$(cat remote-version.txt)
          else
            OLD_VERSION=""
          fi

          echo "Previous Remote Version: ${OLD_VERSION:-N/A (First Run)}"
          
          # 4. å¯¹æ¯”ç‰ˆæœ¬å·
          if [ "$CURRENT_VERSION" == "$OLD_VERSION" ]; then
            echo "Remote rule version is unchanged. Skipping conversion."
            echo "SHOULD_CONVERT_REMOTE=false" >> $GITHUB_ENV
          else
            echo "Remote rule version updated (${OLD_VERSION} -> ${CURRENT_VERSION}). Converting."
            echo "SHOULD_CONVERT_REMOTE=true" >> $GITHUB_ENV
            # å‡†å¤‡å†™å…¥æ–°çš„ç‰ˆæœ¬å·
            echo "$CURRENT_VERSION" > remote-version.txt
          fi

      - name: ğŸ”„ Convert Remote RuleSet to MRS
        if: env.SHOULD_CONVERT_REMOTE == 'true'
        run: |
          echo "Converting remote RuleSet using 'mihomo convert-ruleset'..."
          # è¿œç¨‹æ–‡ä»¶æ˜¯ domain yaml æ ¼å¼
          /usr/local/bin/mihomo convert-ruleset domain yaml remote-rule.yaml ${{ env.REMOTE_RULES_MRS_FILE }}
          echo "Remote RuleSet conversion complete."
      
      # ğŸ’¾ Save Remote Rules New Version to Cache (å¿…é¡»åœ¨ Job ç»“æŸå‰è¿è¡Œ)
      - name: ğŸ’¾ Save Remote Rules New Version Cache
        uses: actions/cache/save@v4
        if: success() && steps.remote-check.outputs.cache-hit != 'true' && env.SHOULD_CONVERT_REMOTE == 'true'
        with:
          path: remote-version.txt
          key: remote-rules-version-${{ hashFiles('remote-version.txt') }}

      # --- 4. æäº¤æ›´æ”¹å›ä»“åº“ ---
      - name: â¬†ï¸ Commit and Push Changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ğŸ¤– Feat: Update Mihomo MRS Rules (v${{ env.CURRENT_VERSION }})"
          branch: ${{ github.ref_name }}
          # ä¸¥æ ¼é™å®šåªæäº¤ mrs ç›®å½•ä¸‹çš„æ–‡ä»¶
          file_pattern: 'mrs/*'
          commit_options: '--allow-empty --no-edit'
