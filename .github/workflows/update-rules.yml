name: Mihomo Rules Update

# æ¯å¤© UTC æ—¶é—´ 4 ç‚¹è¿è¡Œ
# æ³¨æ„ï¼šGitHub Actions çš„å®šæ—¶ä»»åŠ¡ä½¿ç”¨ UTC æ—¶é—´ï¼Œ
# å¦‚æœæ‚¨æƒ³åœ¨**åŒ—äº¬æ—¶é—´**æ¯å¤©æ—©ä¸Š 4 ç‚¹è¿è¡Œï¼Œ
# åˆ™éœ€è¦è®¾ç½®ä¸º UTC æ¯å¤© 20 ç‚¹ï¼ˆ20:00ï¼‰ï¼Œå³ '0 20 * * *'ã€‚
on:
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘
  schedule:
    # æ¯å¤© UTC 20:00 è¿è¡Œ (ç›¸å½“äºåŒ—äº¬æ—¶é—´æ¬¡æ—¥ 04:00)
    - cron: '0 20 * * *' 

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: â¬‡ï¸ Checkout Repository
        uses: actions/checkout@v4
        # éœ€è¦ fetch å†å²è®°å½•æ‰èƒ½æ­£ç¡®ä½¿ç”¨ git log è¿›è¡Œæ–‡ä»¶æ—¶é—´åˆ¤æ–­
        with:
          fetch-depth: 0 

      # --- 1. Mihomo ç¼“å­˜å’Œæ›´æ–° ---
      - name: âš™ï¸ Setup Mihomo Cache
        id: cache-mihomo
        uses: actions/cache@v4
        with:
          path: /usr/local/bin/mihomo # Mihomo çš„å®‰è£…è·¯å¾„
          key: ${{ runner.os }}-mihomo-v1 
          
      - name: ğŸ“¥ Download or Update Mihomo
        if: steps.cache-mihomo.outputs.cache-hit != 'true'
        # è¿™æ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼Œæ‚¨éœ€è¦æ ¹æ® mihomo çš„å®é™…ä¸‹è½½é“¾æ¥æ¥è°ƒæ•´
        run: |
          MIHOMO_VERSION="v1.17.0" # æ›¿æ¢ä¸ºæ‚¨éœ€è¦çš„ç‰ˆæœ¬
          MIHOMO_URL="https://github.com/MetaCubeX/mihomo/releases/download/${MIHOMO_VERSION}/mihomo-linux-amd64-${MIHOMO_VERSION}"
          
          echo "Downloading Mihomo from: ${MIHOMO_URL}"
          curl -L -o mihomo "${MIHOMO_URL}"
          chmod +x mihomo
          sudo mv mihomo /usr/local/bin/mihomo
          echo "mihomo downloaded and installed."
          
      # æ£€æŸ¥ Mihomo ç‰ˆæœ¬ï¼ˆå¯é€‰æ­¥éª¤ï¼Œç”¨äºæ£€æµ‹æ›´æ–°ï¼Œå¦‚æœæ¯æ¬¡éƒ½ä½¿ç”¨å›ºå®šç‰ˆæœ¬å¯ä»¥çœç•¥ï¼‰
      - name: ğŸ” Check Mihomo Version
        run: mihomo -v
      
      # --- 2. å‡†å¤‡å·¥ä½œç›®å½• ---
      - name: ğŸ“‚ Create Output Directory
        run: mkdir -p mrs

      # --- 3. å¤„ç†æœ¬åœ° rules è§„åˆ™æ–‡ä»¶ ---
      - name: â³ Check Local Rules Update Time
        id: check-local-rules
        # ä½¿ç”¨ git log æ£€æŸ¥ rules æ–‡ä»¶å¤¹ä¸­æ‰€æœ‰æ–‡ä»¶çš„æœ€æ–°ä¿®æ”¹æ—¶é—´
        run: |
          LAST_COMMIT_TIME=$(git log -1 --pretty=format:%at -- rules)
          # è·å–å½“å‰æ—¶é—´æˆ³
          CURRENT_TIME=$(date +%s)
          # è®¾ç½®ä¸€ä¸ªç¼“å­˜æ–‡ä»¶æ¥å­˜å‚¨ä¸Šæ¬¡ç”Ÿæˆçš„æ—¶é—´æˆ³
          CACHE_LOG_FILE="${{ runner.temp }}/last_rules_build_time.log"
          
          if [ -f "$CACHE_LOG_FILE" ]; then
            LAST_BUILD_TIME=$(cat "$CACHE_LOG_FILE")
          else
            # ç¬¬ä¸€æ¬¡è¿è¡Œæˆ–ç¼“å­˜å¤±æ•ˆæ—¶ï¼Œä½¿ç”¨ä¸€ä¸ªéå¸¸æ—©çš„æ—¶é—´æˆ³ç¡®ä¿ç”Ÿæˆ
            LAST_BUILD_TIME=0 
          fi
          
          echo "Last Rules Commit Time (Unix): $LAST_COMMIT_TIME"
          echo "Last Rules Build Time (Cache): $LAST_BUILD_TIME"
          
          # å¦‚æœè§„åˆ™æ–‡ä»¶æœ‰æ›´æ–°ï¼Œæˆ–è€…ä¸Šæ¬¡ç”Ÿæˆæ—¶é—´æ¯”è§„åˆ™æäº¤æ—¶é—´æ—©ï¼Œåˆ™è®¾ç½®æ ‡å¿—
          if [ "$LAST_COMMIT_TIME" -gt "$LAST_BUILD_TIME" ]; then
            echo "Rules folder has updates. Will regenerate."
            echo "SHOULD_REGENERATE=true" >> $GITHUB_ENV
          else
            echo "Rules folder has no updates since last build. Skipping regeneration."
            echo "SHOULD_REGENERATE=false" >> $GITHUB_ENV
          fi
          
          # æ— è®ºæ˜¯å¦ç”Ÿæˆï¼Œéƒ½å°†å½“å‰æ—¶é—´æˆ³å†™å…¥æ—¥å¿—æ–‡ä»¶ï¼Œä¾›ä¸‹æ¬¡ä½¿ç”¨
          echo "$CURRENT_TIME" > "$CACHE_LOG_FILE"
          
      - name: ğŸ› ï¸ Convert Local Rules to MRS
        if: env.SHOULD_REGENERATE == 'true'
        run: |
          echo "Converting local rules..."
          find rules -type f -name "*.list" | while read -r file; do
            filename=$(basename "$file" .list)
            /usr/local/bin/mihomo rule convert -F "$file" -O "mrs/${filename}.mrs"
          done
          echo "Local rules conversion complete."
          
      # --- 4. å¤„ç†è¿œç¨‹ YAML è§„åˆ™æ–‡ä»¶ ---
      - name: ğŸŒ Download Remote YAML Rule
        run: |
          REMOTE_URL="https://raw.githubusercontent.com/TG-Twilight/AWAvenue-Ads-Rule/main/Filters/AWAvenue-Ads-Rule-Clash.yaml"
          curl -L -o remote-rule.yaml "$REMOTE_URL"
          echo "Remote YAML rule downloaded."
          
      - name: ğŸ”„ Convert Remote Rule to MRS
        run: |
          /usr/local/bin/mihomo rule convert -F remote-rule.yaml -O mrs/AWAvenue-Ads-Rule.mrs
          echo "Remote rule conversion complete."

      # --- 5. æäº¤æ›´æ”¹å›ä»“åº“ ---
      - name: â¬†ï¸ Commit and Push Changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ğŸ¤– Feat: Update Mihomo MRS Rules"
          branch: ${{ github.ref_name }} # æäº¤åˆ°å½“å‰åˆ†æ”¯
          file_pattern: 'mrs/*'
          # åªæœ‰å½“ mrs æ–‡ä»¶å¤¹ä¸­çš„æ–‡ä»¶æœ‰å˜åŒ–æ—¶æ‰æ‰§è¡Œæäº¤
          commit_options: '--allow-empty --no-edit'
