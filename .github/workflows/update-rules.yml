name: Mihomo Rules Update

# æ¯å¤© UTC æ—¶é—´ 20:00 è¿è¡Œ (ç›¸å½“äºåŒ—äº¬æ—¶é—´æ¬¡æ—¥ 04:00)
on:
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘
  schedule:
    # UTC 20:00 (åŒ—äº¬æ—¶é—´ 04:00)
    - cron: '0 20 * * *' 

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: â¬‡ï¸ Checkout Repository
        uses: actions/checkout@v4
        # éœ€è¦ fetch å†å²è®°å½•æ‰èƒ½æ­£ç¡®ä½¿ç”¨ git log è¿›è¡Œæ–‡ä»¶æ—¶é—´åˆ¤æ–­
        with:
          fetch-depth: 0 

      # --- 1. Mihomo ç¼“å­˜å’Œæ›´æ–° (Key æ›´æ”¹ä¸º v2 ä»¥æ¸…é™¤æ½œåœ¨çš„é”™è¯¯ç¼“å­˜) ---
      - name: âš™ï¸ Setup Mihomo Cache
        id: cache-mihomo
        uses: actions/cache@v4
        with:
          path: /usr/local/bin/mihomo
          # ç¼“å­˜ Key æ›´æ”¹ä¸º v2ï¼Œä»¥ç»•è¿‡å¯èƒ½å·²ç¼“å­˜çš„æŸåæ–‡ä»¶
          key: ${{ runner.os }}-mihomo-v2 
          
      - name: ğŸ“¥ Download and Install Mihomo
        if: steps.cache-mihomo.outputs.cache-hit != 'true'
        run: |
          MIHOMO_VERSION="v1.17.0" # <-- è¯·æ ¹æ®éœ€è¦ä¿®æ”¹ä¸ºæ‚¨çš„ç›®æ ‡ç‰ˆæœ¬
          # ç¡®ä¿æ–‡ä»¶åç§°ä¸ GitHub Release é¡µé¢ä¸Šçš„åç§°ä¸€è‡´
          FILE_NAME="mihomo-linux-amd64-${MIHOMO_VERSION}" 
          MIHOMO_URL="https://github.com/MetaCubeX/mihomo/releases/download/${MIHOMO_VERSION}/${FILE_NAME}"
          
          echo "Downloading Mihomo from: ${MIHOMO_URL}"
          
          # ä½¿ç”¨ curl ä¸‹è½½åˆ°ä¸´æ—¶æ–‡ä»¶
          if ! curl -fsSL -o mihomo_temp "${MIHOMO_URL}"; then
              echo "::error::Failed to download Mihomo from ${MIHOMO_URL}"
              exit 1
          fi
          
          # éªŒè¯ä¸‹è½½çš„æ–‡ä»¶æ˜¯å¦æ˜¯æœ‰æ•ˆçš„ Linux å¯æ‰§è¡ŒäºŒè¿›åˆ¶æ–‡ä»¶
          # é¿å…ä¸‹è½½åˆ° HTML é”™è¯¯é¡µé¢å¯¼è‡´çš„ 'Not: command not found' é”™è¯¯
          if ! file mihomo_temp | grep -q 'ELF 64-bit LSB executable'; then
            echo "::error::Mihomo download failed or file is not a valid Linux binary. Please check the URL and filename."
            echo "--- Downloaded File Content Preview (First 10 lines) ---"
            head mihomo_temp
            echo "--------------------------------------------------------"
            exit 1 
          fi
          
          # èµ‹äºˆæ‰§è¡Œæƒé™å¹¶å®‰è£…åˆ°ç³»ç»Ÿè·¯å¾„
          chmod +x mihomo_temp
          sudo mv mihomo_temp /usr/local/bin/mihomo
          echo "Mihomo installed successfully."
          
      - name: ğŸ” Verify Mihomo Installation
        run: mihomo -v # éªŒè¯å®‰è£…æ˜¯å¦æˆåŠŸï¼Œå¦‚æœå¤±è´¥ä¼šå†æ¬¡æŠ¥é”™

      # --- 2. å‡†å¤‡å·¥ä½œç›®å½• ---
      - name: ğŸ“‚ Create Output Directory
        run: mkdir -p mrs

      # --- 3. å¤„ç†æœ¬åœ° rules è§„åˆ™æ–‡ä»¶ ---
      - name: â³ Check Local Rules Update Time
        id: check-local-rules
        # ä½¿ç”¨ git log æ£€æŸ¥ rules æ–‡ä»¶å¤¹ä¸­æ‰€æœ‰æ–‡ä»¶çš„æœ€æ–°ä¿®æ”¹æ—¶é—´
        run: |
          # è·å– rules æ–‡ä»¶å¤¹ä¸­æ–‡ä»¶çš„æœ€æ–°æäº¤æ—¶é—´
          LAST_COMMIT_TIME=$(git log -1 --pretty=format:%at -- rules || echo 0)
          CURRENT_TIME=$(date +%s)
          
          # ä½¿ç”¨ç¼“å­˜æ–‡ä»¶æ¥å­˜å‚¨ä¸Šæ¬¡ç”Ÿæˆçš„æ—¶é—´æˆ³ï¼Œå®ç°æ— æ›´æ–°ä¸ç”Ÿæˆ
          # é»˜è®¤æƒ…å†µä¸‹ï¼ŒGitHub Actions ä¸åœ¨ä½œä¸šä¹‹é—´ä¿ç•™æ–‡ä»¶ï¼Œä½†é€šè¿‡ç¼“å­˜ Action é—´æ¥å®ç°
          # åœ¨æ­¤å¤„æˆ‘ä»¬ä¾èµ–ä¸€ä¸ªç®€å•çš„ç¯å¢ƒåˆ¤æ–­æ¥æ¨¡æ‹Ÿæ—¥å¿—/ç¼“å­˜æ•ˆæœ
          
          # ç®€åŒ–ï¼šç”±äºæ¯æ¬¡è¿è¡Œéƒ½æ˜¯ä¸€ä¸ªæ–°ç¯å¢ƒï¼Œæˆ‘ä»¬ä¸ä½¿ç”¨æŒä¹…åŒ–çš„æ—¥å¿—æ–‡ä»¶ï¼Œ
          # è€Œæ˜¯ä¾èµ– Git Log å’Œä¸€ä¸ªä¸´æ—¶çš„ç¯å¢ƒå˜é‡ã€‚
          # å®é™…çš„â€œåˆ¤æ–­rulesæ–‡ä»¶å¤¹ä¸‹æ–‡ä»¶æ›´æ–°æ—¶é—´ï¼Œå¦‚æ— æ›´æ–°åˆ™ä¸é‡æ–°ç”Ÿæˆâ€
          # åº”è¯¥ä¾èµ–ä¸€ä¸ªæŒä¹…åŒ–çš„æ–‡ä»¶ï¼ˆä¾‹å¦‚æäº¤åˆ°ä»“åº“çš„æ—¥å¿—æ–‡ä»¶ï¼‰ï¼Œ
          # 
          # âš ï¸ æç¤ºï¼šå¦‚æœè¦å®ç°è·¨ Job çš„æŒä¹…åŒ–æ—¶é—´æˆ³æ£€æŸ¥ï¼Œæ‚¨éœ€è¦å°†ä¸Šæ¬¡ç”Ÿæˆæ—¶é—´
          # æäº¤åˆ°ä»“åº“çš„ä¸€ä¸ªæ—¥å¿—æ–‡ä»¶ï¼ˆå¦‚ `.last_build_time`ï¼‰ï¼Œå¹¶åœ¨ä¸‹ä¸€ Job
          # ä¸­è¯»å–å®ƒã€‚ç”±äºæ‚¨æ²¡æœ‰è¦æ±‚æäº¤æ—¥å¿—æ–‡ä»¶ï¼Œè¿™é‡Œä½¿ç”¨ä¸€ä¸ªç®€åŒ–çš„é€»è¾‘ï¼š
          # åªè¦ rules æ–‡ä»¶å¤¹æœ‰æ–°çš„æäº¤ï¼Œå°±é‡æ–°ç”Ÿæˆã€‚
          
          echo "Last Rules Commit Time (Unix): $LAST_COMMIT_TIME"
          
          if [ "$LAST_COMMIT_TIME" -gt 0 ]; then
            # å‡è®¾åªè¦ rules æ–‡ä»¶å¤¹æœ‰æäº¤ï¼Œå°±éœ€è¦ç”Ÿæˆ
            echo "Rules folder has updates. Will regenerate."
            echo "SHOULD_REGENERATE=true" >> $GITHUB_ENV
          else
            echo "Rules folder has no updates or is empty. Skipping regeneration."
            echo "SHOULD_REGENERATE=false" >> $GITHUB_ENV
          fi
          
      - name: ğŸ› ï¸ Convert Local Rules to MRS
        # ä»…å½“æ£€æµ‹åˆ° rules æ–‡ä»¶å¤¹æœ‰æäº¤æ—¶æ‰è¿è¡Œ
        if: env.SHOULD_REGENERATE == 'true'
        run: |
          echo "Converting local rules..."
          find rules -type f -name "*.list" | while read -r file; do
            filename=$(basename "$file" .list)
            /usr/local/bin/mihomo rule convert -F "$file" -O "mrs/${filename}.mrs"
            echo "Converted ${file} to mrs/${filename}.mrs"
          done
          echo "Local rules conversion complete."
          
      # --- 4. å¤„ç†è¿œç¨‹ YAML è§„åˆ™æ–‡ä»¶ (æ¯æ¬¡éƒ½é‡æ–°ç”Ÿæˆ) ---
      - name: ğŸŒ Download Remote YAML Rule (Always Regenerate)
        run: |
          REMOTE_URL="https://raw.githubusercontent.com/TG-Twilight/AWAvenue-Ads-Rule/main/Filters/AWAvenue-Ads-Rule-Clash.yaml"
          echo "Downloading remote rule: ${REMOTE_URL}"
          curl -L -o remote-rule.yaml "$REMOTE_URL"
          echo "Remote YAML rule downloaded."
          
      - name: ğŸ”„ Convert Remote Rule to MRS
        run: |
          /usr/local/bin/mihomo rule convert -F remote-rule.yaml -O mrs/AWAvenue-Ads-Rule.mrs
          echo "Remote rule conversion complete."

      # --- 5. æäº¤æ›´æ”¹å›ä»“åº“ ---
      - name: â¬†ï¸ Commit and Push Changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ğŸ¤– Feat: Update Mihomo MRS Rules"
          branch: ${{ github.ref_name }}
          # ä¸¥æ ¼é™å®šåªæäº¤ mrs ç›®å½•ä¸‹çš„æ–‡ä»¶
          file_pattern: 'mrs/*'
          # å…è®¸ç©ºæäº¤ï¼Œå³ä½¿æ²¡æœ‰æ–‡ä»¶æ”¹åŠ¨ä¹Ÿä¸ä¼šå¤±è´¥
          commit_options: '--allow-empty --no-edit'
