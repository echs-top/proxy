name: Mihomo Rules Update

on:
  workflow_dispatch:
  schedule:
    - cron: '0 20 * * *'

env:
  MIHOMO_OWNER: MetaCubeX
  MIHOMO_REPO: mihomo

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: â¬‡ï¸ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # --- 1. å®‰è£…/ç¼“å­˜ Mihomo ---
      - name: ğŸ” Get Latest Mihomo Release Tag
        id: get-version
        run: |
          LATEST_TAG=$(curl -s "https://api.github.com/repos/${{ env.MIHOMO_OWNER }}/${{ env.MIHOMO_REPO }}/releases/latest" | jq -r .tag_name)
          echo "LATEST_TAG=$LATEST_TAG" >> $GITHUB_ENV
        
      - name: âš™ï¸ Setup Mihomo Cache
        id: cache-mihomo
        uses: actions/cache@v4
        with:
          path: /usr/local/bin/mihomo
          key: ${{ runner.os }}-mihomo-${{ env.LATEST_TAG }}
          
      - name: ğŸ“¥ Download and Install Mihomo
        if: steps.cache-mihomo.outputs.cache-hit != 'true'
        run: |
          MIHOMO_VERSION="${{ env.LATEST_TAG }}"
          FILE_NAME="mihomo-linux-amd64-${MIHOMO_VERSION}.gz"
          curl -fsSL -o "mihomo.gz" "https://github.com/${{ env.MIHOMO_OWNER }}/${{ env.MIHOMO_REPO }}/releases/download/${MIHOMO_VERSION}/${FILE_NAME}"
          gunzip "mihomo.gz"
          chmod +x mihomo
          sudo mv mihomo /usr/local/bin/mihomo

      # --- 2. è¿œç¨‹è§„åˆ™å“ˆå¸Œç¼“å­˜åŠ è½½ ---
      - name: ğŸ’¾ Restore Remote Hashes Cache
        id: restore-hash
        uses: actions/cache/restore@v4
        with:
          path: remote-hashes.txt
          key: remote-hashes-${{ github.run_id }}
          restore-keys: |
            remote-hashes-

      - name: ğŸ“‚ Create Directories
        run: mkdir -p rules/mrs rules/list rules/yaml

      # --- 3. ä¸‹è½½å¹¶è¿›è¡Œå“ˆå¸Œå¯¹æ¯” ---
      - name: ğŸŒ Download and Check Remote Rules
        id: download-step
        run: |
          touch remote-hashes.txt
          touch updated_files.txt # ç”¨äºè®°å½•å“ªäº›è¿œç¨‹æ–‡ä»¶å‘ç”Ÿäº†å˜åŒ–
          
          download_and_check() {
            local conf=$1
            local target_dir=$2
            if [ -f "$conf" ]; then
              while read -r name url || [ -n "$name" ]; do
                [[ -z "$name" || "$name" =~ ^# ]] && continue
                echo "Downloading $name..."
                curl -fsSL -o "$target_dir/$name" "$url"
                
                # è®¡ç®—æ–°å“ˆå¸Œ
                NEW_HASH=$(md5sum "$target_dir/$name" | awk '{print $1}')
                # ä»ç¼“å­˜æ–‡ä»¶ä¸­è¯»å–æ—§å“ˆå¸Œ
                OLD_HASH=$(grep "^$name " remote-hashes.txt | awk '{print $2}')
                
                if [ "$NEW_HASH" != "$OLD_HASH" ]; then
                  echo "$name updated (Hash: $NEW_HASH)"
                  echo "$name" >> updated_files.txt
                  # æ›´æ–°å“ˆå¸Œåˆ—è¡¨è®°å½•ï¼ˆå…ˆåˆ å†åŠ ï¼‰
                  sed -i "/^$name /d" remote-hashes.txt
                  echo "$name $NEW_HASH" >> remote-hashes.txt
                else
                  echo "$name is same as cache. Skipping hash update."
                fi
              done < "$conf"
            fi
          }

          download_and_check "rules/list/remote" "rules/list"
          download_and_check "rules/yaml/remote" "rules/yaml"

      # --- 4. ç»Ÿä¸€å¤„ç†ä¸è½¬æ¢ ---
      - name: ğŸ› ï¸ Convert Rules to MRS
        run: |
          TEMP_DIR=$(mktemp -d)
          TYPES=("rules/list|text" "rules/yaml|yaml")

          for entry in "${TYPES[@]}"; do
            DIR="${entry%%|*}"
            FORMAT="${entry#*|}"
            [ ! -d "$DIR" ] && continue

            find "$DIR" -type f ! -name "remote" | while read -r file; do
              filename=$(basename "$file")
              out_name="${filename%.*}"
              mrs_file="rules/mrs/${out_name}.mrs"
              
              # ç­–ç•¥åˆ¤æ–­ï¼š
              # 1. å¦‚æœåœ¨ updated_files.txt ä¸­ï¼ˆè¿œç¨‹æ›´æ–°ï¼‰
              # 2. å¦‚æœæ–‡ä»¶æ¯”å·²æœ‰çš„ mrs æ–°ï¼ˆæœ¬åœ°æ›´æ–°ï¼‰
              # 3. å¦‚æœ mrs æ–‡ä»¶ä¸å­˜åœ¨
              IS_REMOTE_UPDATED=$(grep -q "^$filename$" updated_files.txt && echo "true" || echo "false")
              INPUT_TIME=$(git log -1 --format=%at -- "$file" 2>/dev/null || stat -c %Y "$file")
              MRS_TIME=$(git log -1 --format=%at -- "$mrs_file" 2>/dev/null || echo 0)

              if [ "$IS_REMOTE_UPDATED" == "true" ] || [ "$INPUT_TIME" -gt "$MRS_TIME" ] || [ ! -f "$mrs_file" ]; then
                # åˆ¤å®šè§„åˆ™è¡Œä¸º
                [[ "$filename" == *"_domain"* ]] && BEHAVIOR="domain" || BEHAVIOR="ipcidr"
                [ "$filename" == "$out_name" ] && BEHAVIOR="domain" # å…œåº•

                echo "ğŸ› ï¸ Converting: $filename (Reason: $( [ "$IS_REMOTE_UPDATED" == "true" ] && echo "Remote Updated" || echo "Local/Missing" ))"
                
                # å»æ³¨é‡Šå¤„ç†
                temp_clean="${TEMP_DIR}/clean_input"
                grep -v '^[[:space:]]*#' "$file" | sed 's/[[:space:]]*#.*$//' | grep -v '^[[:space:]]*$' > "$temp_clean"

                if [ -s "$temp_clean" ]; then
                  /usr/local/bin/mihomo convert-ruleset "$BEHAVIOR" "$FORMAT" "$temp_clean" "$mrs_file"
                fi
              fi
            done
          done
          rm -rf "$TEMP_DIR"

      # --- 5. ä¿å­˜å“ˆå¸Œç¼“å­˜ä¸æäº¤æ›´æ”¹ ---
      - name: ğŸ’¾ Save Remote Hashes Cache
        uses: actions/cache/save@v4
        if: always()
        with:
          path: remote-hashes.txt
          key: remote-hashes-${{ github.run_id }}

      - name: â¬†ï¸ Commit and Push
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ğŸ¤– Feat: Update Mihomo MRS (Cache Optimized)"
          file_pattern: 'rules/mrs/*'
